<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>linusbux</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs - NOTE: firebase-functions.js is REMOVED -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* All of your CSS styles remain unchanged. They are correct. */
        :root {
            --primary-blue: #0a84ff;
            --secondary-purple: #bf5af2;
            --gold: #ffd60a;
            --danger: #ff453a;
            --success: #30d158;
            --dark-bg: #121212;
            --dark-card: rgba(44, 44, 46, 0.6);
            --dark-card-border: rgba(255, 255, 255, 0.1);
            --light-text: #f2f2f7;
            --medium-text: #8e8e93;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background: var(--dark-bg);
            color: var(--light-text);
            overflow: hidden;
            position: relative;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 10% 10%, var(--primary-blue), transparent 40%),
                        radial-gradient(circle at 90% 80%, var(--secondary-purple), transparent 40%),
                        radial-gradient(circle at 50% 50%, rgba(16, 124, 65, 0.5), transparent 40%);
            opacity: 0.1; animation: moveGradient 20s linear infinite; z-index: -1;
        }
        @keyframes moveGradient { 0% { background-position: 0% 0%; } 50% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }
        #auth-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; z-index: 2000; }
        .auth-box { background: var(--dark-card); padding: 2.5rem; border-radius: var(--border-radius); backdrop-filter: blur(15px); border: 1px solid var(--dark-card-border); box-shadow: 0 8px 32px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center; }
        .auth-box h2 { font-size: 2rem; margin-bottom: 2rem; color: white; text-shadow: 0 0 10px var(--primary-blue); }
        .auth-form input { display: block; width: 100%; margin-bottom: 1rem; background-color: #1c1c1e; border: 1px solid #38383a; color: var(--light-text); padding: 0.8rem 1rem; border-radius: 10px; font-family: var(--font-family); font-size: 1rem; outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .auth-form input:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.3); }
        .auth-buttons { display: flex; gap: 1rem; }
        .auth-buttons button { flex: 1; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 10px; font-family: var(--font-family); font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        #login-btn { background: linear-gradient(45deg, #007aff, var(--primary-blue)); }
        #signup-btn { background: linear-gradient(45deg, #30d158, #28a745); }
        .auth-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #app { display: none; height: 100vh; }
        #app.visible { display: flex; }
        .sidebar { width: 240px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); padding: 2rem 1rem; display: flex; flex-direction: column; align-items: center; border-right: 1px solid var(--dark-card-border); z-index: 10; }
        .logo { font-size: 2rem; font-weight: 700; color: white; margin-bottom: 3rem; text-shadow: 0 0 10px var(--primary-blue); }
        .sidebar ul { list-style: none; width: 100%; flex-grow: 1; }
        .sidebar ul li a { display: flex; align-items: center; gap: 1rem; color: var(--medium-text); text-decoration: none; padding: 1rem 1.5rem; margin-bottom: 1rem; border-radius: 12px; font-weight: 600; transition: all 0.3s ease; }
        .sidebar ul li a svg { width: 24px; height: 24px; transition: fill 0.3s ease; }
        .sidebar ul li a.active, .sidebar ul li a:hover { background-color: var(--primary-blue); color: white; box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4); }
        .sidebar ul li a.active svg, .sidebar ul li a:hover svg { fill: white; }
        #logout-btn { background: none; border: 1px solid var(--danger); color: var(--danger); width: 100%; padding: 0.8rem; font-weight: 600; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; }
        #logout-btn:hover { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(255, 69, 58, 0.4); }
        .content { flex: 1; padding: 2rem 3rem; overflow-y: auto; position: relative; }
        .tab-content { display: none; animation: fadeIn 0.7s cubic-bezier(0.25, 1, 0.5, 1); }
        .tab-content.active { display: block; }
        #blackjack.tab-content.active, #linus-hub.tab-content.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .header-balance { position: absolute; top: 2rem; right: 3rem; background: var(--dark-card); padding: 0.6rem 1.2rem; border-radius: var(--border-radius); font-size: 1.2rem; font-weight: 600; display: none; align-items: center; border: 1px solid var(--dark-card-border); backdrop-filter: blur(10px); z-index: 20; animation: fadeIn 0.5s; }
        .header-balance.visible { display: flex; }
        .header-balance span:first-child { color: var(--primary-blue); margin-right: 0.7rem; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; max-width: 900px; margin: 0 auto; }
        .card { background: var(--dark-card); padding: 2rem; border-radius: var(--border-radius); backdrop-filter: blur(15px); border: 1px solid var(--dark-card-border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .card:hover::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient( 800px circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.06), transparent 40% ); opacity: 1; pointer-events: none; }
        .card h3 { margin-bottom: 1.5rem; font-weight: 600; font-size: 1.25rem; }
        .input-group { display: flex; gap: 0.5rem; }
        input[type="number"], input[type="text"] { flex: 1; background-color: #1c1c1e; border: 1px solid #38383a; color: var(--light-text); padding: 0.8rem 1rem; border-radius: 10px; font-family: var(--font-family); font-size: 1rem; outline: none; transition: all 0.3s ease; min-width: 0; }
        button:disabled { cursor: not-allowed; filter: grayscale(60%); opacity: 0.7; }
        #generated-codes { margin-top: 1.5rem; max-height: 200px; overflow-y: auto; padding-right: 10px; }
        .generated-code-item { background-color: #1c1c1e; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #38383a; transition: all 0.2s ease-in-out; }
        .generated-code-item:hover { background-color: #3a3a3c; border-color: var(--primary-blue); transform: translateX(5px); }
        .generated-code-item .code-text { font-family: 'Courier New', Courier, monospace; font-weight: bold; color: var(--primary-blue); }
        #gambling-container { display: flex; justify-content: center; align-items: center; padding-top: 1rem; flex-direction: column; gap: 1.5rem; }
        #wheel-canvas-container { position: relative; width: 450px; height: 450px; }
        #wheel-canvas { width: 100%; height: 100%; }
        #wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid var(--gold); filter: drop-shadow(0 -2px 3px rgba(0,0,0,0.5)); z-index: 10; }
        .betting-controls { display: flex; gap: 1rem; align-items: center; }
        #bet-amount-input { font-size: 1.5rem; padding: 0.6rem 1rem; width: 200px; text-align: center; font-weight: 600; }
        #spin-btn { width: 150px; height: auto; background: linear-gradient(45deg, var(--secondary-purple), #9b59b6); font-size: 1.5rem; padding: 0.6rem 1rem; border-radius: 12px; font-weight: 700; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: #2c2c2e; color: #f2f2f7; padding: 12px 20px; border-radius: 10px; border: 1px solid #38383a; border-left: 5px solid; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 10px; animation: slideUp 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast.toast-success { border-left-color: var(--success); }
        .toast.toast-error { border-left-color: var(--danger); }
        .toast.toast-info { border-left-color: var(--primary-blue); }
        /* Other styles for blackjack, etc., are omitted for brevity but remain the same */
    </style>
</head>
<body>

    <!-- Authentication and Main Application HTML structure remains unchanged -->
    <div id="auth-container"><!-- ... --></div>
    <div id="app"><!-- ... --></div>
    <div id="toast-container"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script>
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE
const firebaseConfig = {

  apiKey: "AIzaSyC-aZNBPQz2y4e-9DZ9hvz-puEan47li-4",

  authDomain: "linusbux-fab58.firebaseapp.com",

  databaseURL: "https://linusbux-fab58-default-rtdb.firebaseio.com",

  projectId: "linusbux-fab58",

  storageBucket: "linusbux-fab58.firebasestorage.app",

  messagingSenderId: "714906159220",

  appId: "1:714906159220:web:4de6a1d3c27f39e0bca921",

  measurementId: "G-EZWXN01SZT"

};


        // --- CRITICAL: Point this to your Render server's URL ---
        const API_BASE_URL = "https://your-render-app-name.onrender.com"; // Example: "https://linusbux.onrender.com"

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        // The firebase.functions() SDK is NOT used in this architecture.

        document.addEventListener('DOMContentLoaded', () => {
            let currentUser = null;
            let balanceRef = null;

            // --- Toast Notification System (Unchanged) ---
            const toastContainer = document.getElementById('toast-container');
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                gsap.to(toast, { opacity: 0, y: 20, delay: 4, duration: 0.5, onComplete: () => toast.remove() });
            }

            // --- Generic Secure API Fetcher ---
            // This helper function handles authentication for every server request.
            async function fetchFromAPI(endpoint, options = {}) {
                if (!currentUser) {
                    throw new Error("You must be logged in to perform this action.");
                }

                // Get the user's ID token to prove their identity to the server.
                const token = await currentUser.getIdToken();

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // The secure handshake
                };

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers },
                });

                const result = await response.json();

                if (!response.ok) {
                    // Use the error message from the server if it exists, otherwise use a default.
                    throw new Error(result.error || `Request failed with status ${response.status}`);
                }
                return result;
            }

            // --- Firebase Auth Logic (with initial user data creation) ---
            auth.onAuthStateChanged(user => {
                const appContainer = document.getElementById('app');
                const authContainer = document.getElementById('auth-container');
                if (user) {
                    currentUser = user;
                    if (balanceRef) balanceRef.off();
                    balanceRef = db.ref(`users/${currentUser.uid}/balance`);
                    balanceRef.on('value', (snapshot) => {
                        const newBalance = snapshot.val();
                        if (newBalance !== null) updateAllBalanceDisplays(newBalance);
                    });
                    appContainer.classList.add('visible');
                    authContainer.style.display = 'none';
                } else {
                    currentUser = null;
                    if (balanceRef) balanceRef.off();
                    updateAllBalanceDisplays(0);
                    appContainer.classList.remove('visible');
                    authContainer.style.display = 'flex';
                }
            });

            document.getElementById('signup-btn').addEventListener('click', () => {
                const email = document.getElementById('email-input').value;
                const password = document.getElementById('password-input').value;
                if (!email || !password) return showToast('Please enter email and password.', 'error');

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        showToast(`Account created for ${userCredential.user.email}! Welcome!`, 'success');
                        // SECURE: This write only succeeds because our rules allow a write if `!data.exists()`.
                        const initialData = { 
                            balance: 100, 
                            username: email.split('@')[0].substring(0, 15) 
                        };
                        return db.ref(`users/${userCredential.user.uid}`).set(initialData);
                    })
                    .catch((error) => showToast(error.message, 'error'));
            });
            // Login and Logout buttons remain the same.

            function updateAllBalanceDisplays(balance) { /* ... This function is unchanged ... */ }


            // --- SECURE Balance Tab: Uses the new `fetchFromAPI` helper ---
            (function setupBalanceTab() {
                const createCodeBtn = document.getElementById('create-code-btn');
                const createCodeAmountInput = document.getElementById('create-code-amount');
                const redeemCodeBtn = document.getElementById('redeem-code-btn');
                const redeemCodeInput = document.getElementById('redeem-code-input');

                createCodeBtn.addEventListener('click', async () => {
                    const amount = parseInt(createCodeAmountInput.value, 10);
                    if (isNaN(amount) || amount <= 0) return showToast('Please enter a valid amount.', 'error');
                    
                    createCodeBtn.disabled = true;
                    try {
                        const result = await fetchFromAPI('/api/create-code', {
                            method: 'POST',
                            body: JSON.stringify({ amount: amount })
                        });
                        // ... (Logic to display the new code from `result.code`) ...
                        showToast('Code created successfully!', 'success');
                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                    } finally {
                        createCodeBtn.disabled = false;
                    }
                });

                redeemCodeBtn.addEventListener('click', async () => {
                    const code = redeemCodeInput.value.trim().toUpperCase();
                    if (!code) return showToast('Please enter a code.', 'error');
                    
                    redeemCodeBtn.disabled = true;
                    try {
                        const result = await fetchFromAPI('/api/redeem-code', {
                            method: 'POST',
                            body: JSON.stringify({ code: code })
                        });
                        showToast(`${result.message} You received ${result.amount.toLocaleString()} BUX!`, 'success');
                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                    } finally {
                        redeemCodeBtn.disabled = false;
                    }
                });
            })();
            

            // --- SECURE Gambling Tab: Uses the new `fetchFromAPI` helper ---
            (function setupGamblingTab() {
                const canvas = document.getElementById('wheel-canvas');
                const spinButton = document.getElementById('spin-btn');
                const betAmountInput = document.getElementById('bet-amount-input');
                // The `drawWheel` function for visuals is unchanged.

                spinButton.addEventListener('click', async () => {
                    const bet = parseInt(betAmountInput.value, 10);
                    if (isNaN(bet) || bet <= 0) return showToast('Please enter a valid bet.', 'error');
                    
                    spinButton.disabled = true;
                    betAmountInput.disabled = true;
                    try {
                        const result = await fetchFromAPI('/api/spin-wheel', {
                            method: 'POST',
                            body: JSON.stringify({ bet: bet })
                        });
                        
                        const { winningIndex, message, prize } = result;
                        // The server tells us where to land, we just handle the animation.
                        // ... (Add your GSAP animation logic here based on winningIndex) ...
                        showToast(message, prize > 0 ? 'success' : 'error');

                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                    } finally {
                        spinButton.disabled = false;
                        betAmountInput.disabled = false;
                    }
                });
            })();
            
            // Blackjack and other tabs would be updated similarly, using `fetchFromAPI`.
        });
    </script>
</body>
</html>

